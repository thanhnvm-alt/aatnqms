
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Turso iOS Diagnostic</title>
    <style>
        :root { --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --ok: #22c55e; --err: #ef4444; --warn: #f59e0b; }
        @media (prefers-color-scheme: dark) { :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; } }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; font-size: 14px; }
        .card { background: var(--card); padding: 15px; border-radius: 16px; margin-bottom: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        h1 { font-size: 18px; font-weight: 900; margin: 0 0 15px 0; text-transform: uppercase; letter-spacing: -0.5px; }
        h2 { font-size: 14px; font-weight: 700; color: #64748b; margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 1px; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .item:last-child { border: none; }
        .status { font-weight: bold; font-family: monospace; }
        .status.ok { color: var(--ok); }
        .status.err { color: var(--err); }
        .status.warn { color: var(--warn); }
        button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 12px; border: none; font-weight: bold; background: #3b82f6; color: white; font-size: 16px; }
        #logs { white-space: pre-wrap; word-break: break-all; background: #000; color: #0f0; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 10px; height: 150px; overflow-y: auto; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>üîç Turso iOS Diagnostic</h1>
    
    <div class="card">
        <h2>Thi·∫øt b·ªã</h2>
        <div class="item"><span>OS</span><span id="os" class="status">Checking...</span></div>
        <div class="item"><span>Browser</span><span id="browser" class="status">Checking...</span></div>
        <div class="item"><span>Private Mode</span><span id="private" class="status">Checking...</span></div>
        <div class="item"><span>Online</span><span id="online" class="status">Checking...</span></div>
    </div>

    <div class="card">
        <h2>T√≠nh nƒÉng</h2>
        <div class="item"><span>LocalStorage</span><span id="ls" class="status">...</span></div>
        <div class="item"><span>BigInt Support</span><span id="bi" class="status">...</span></div>
        <div class="item"><span>Fetch API</span><span id="fetch" class="status">...</span></div>
        <div class="item"><span>WebSocket</span><span id="ws" class="status">...</span></div>
    </div>

    <div class="card">
        <h2>K·∫øt n·ªëi</h2>
        <div class="item"><span>API Health</span><span id="api" class="status">Waiting...</span></div>
        <div class="item"><span>Turso Direct</span><span id="db" class="status">Waiting...</span></div>
    </div>

    <div class="card">
        <h2>Logs</h2>
        <div id="logs">Ready to start...</div>
        <button onclick="copyLogs()">Copy Logs</button>
    </div>

    <button onclick="runTests()">CH·∫†Y KI·ªÇM TRA</button>

    <script>
        const log = (msg) => {
            const el = document.getElementById('logs');
            el.innerHTML += `\n[${new Date().toLocaleTimeString()}] ${msg}`;
            el.scrollTop = el.scrollHeight;
            console.log(msg);
        };

        const setStatus = (id, status, text) => {
            const el = document.getElementById(id);
            el.className = `status ${status}`;
            el.innerText = text;
        };

        async function checkPrivate() {
            try {
                localStorage.setItem('test', '1');
                localStorage.removeItem('test');
                return false;
            } catch (e) {
                return true;
            }
        }

        async function runTests() {
            document.getElementById('logs').innerHTML = 'Starting tests...';
            
            // 1. Platform
            const ua = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            setStatus('os', 'ok', isIOS ? 'iOS' : 'Android/Desktop');
            setStatus('browser', 'ok', /CriOS/.test(ua) ? 'Chrome iOS' : /Safari/.test(ua) ? 'Safari' : 'Other');
            setStatus('online', navigator.onLine ? 'ok' : 'err', navigator.onLine ? 'YES' : 'NO');

            const isIncognito = await checkPrivate();
            setStatus('private', isIncognito ? 'warn' : 'ok', isIncognito ? 'YES (Warning)' : 'NO');

            // 2. Capabilities
            try {
                const bi = typeof BigInt !== 'undefined';
                setStatus('bi', bi ? 'ok' : 'err', bi ? 'Supported' : 'Missing');
                if(bi) {
                    try { JSON.stringify({val: BigInt(1)}) } catch(e) { log('JSON cannot serialize BigInt (Expected)'); }
                }
            } catch(e) { setStatus('bi', 'err', 'Error'); }

            setStatus('ls', 'ok', 'Available');
            setStatus('fetch', window.fetch ? 'ok' : 'err', window.fetch ? 'OK' : 'Missing');
            setStatus('ws', 'WebSocket' in window ? 'ok' : 'err', 'WebSocket' in window ? 'OK' : 'Blocked');

            // 3. API Health Check
            log('Testing API Route...');
            try {
                const start = Date.now();
                const res = await fetch('/api/health');
                const time = Date.now() - start;
                if(res.ok) {
                    const data = await res.json();
                    setStatus('api', 'ok', `OK (${time}ms)`);
                    log(`API Success: ${JSON.stringify(data)}`);
                } else {
                    throw new Error(res.statusText);
                }
            } catch (e) {
                setStatus('api', 'err', 'FAILED');
                log(`API Fail: ${e.message}`);
            }

            log('Tests completed.');
        }

        function copyLogs() {
            const text = document.getElementById('logs').innerText;
            navigator.clipboard.writeText(text);
            alert('Copied to clipboard');
        }
        
        // Auto run
        setTimeout(runTests, 1000);
    </script>
</body>
</html>
